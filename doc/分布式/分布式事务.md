# 分布式事务

##  1. 二阶段提交 2PC

阶段

* 准备阶段
* 提交阶段

参与角色

* 协调者：事务的发起者
* 参与者：事务的执行者

### 1.1 阶段概述

1. 投票阶段
2. 提交阶段

案例 运动会 裁判为协调者 运动员为参与者

1. 性能问题：参与者事务阻塞，第三方访问资源进入阻塞状态
2. 可靠性问题：参与者发生故障的时候，协调者需要给每个参与者额外指定超时机制，超时后整个事务失败，
   协调者发生故障的时候，参与者会一致阻塞下去，需要额外的备机进行容错
3. 数据一致性问题：二阶段无法解决的问题，协调者在发出commit消息之后宕机，而唯一接收到这条消息的参与者同时也
   宕机了，那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否已经被提交
   
* 优点：尽量保证了数据的强一致，适合对数据强一致要求很高的关键领域
* 缺点：实现复杂，牺牲了可用性，对性能影响较大，不适合高并发高性能场景

## 2. 三阶段提交协议 3PC

3PC是2PC的改进
* 在协调者和参与者中都引入的超时机制
* 在第一阶段和第二阶段中插入一个准备阶段，保证了在最后提交阶段之前各参节点状态是一致的

### 2.1 流程

* 1. can-commit 询问各个参与者是否可以正常执行，预估判断是否可以执行
* 2. pre-commit 正常执行进入pre-commit 不满足或者超时进入abort，执行事务但不提交
* 3. do-commit 向所有参与者发出事务提交通知
    
在doCommit阶段，如果参与者无法及时接收到来自协调者的doCommit或者rebort请求时，会在等待超时之后继续进行事务的提交

优点：相比2PC，3PC降低了阻塞范围，在等待超时后协调者或参与者会中断事务，避免了协调者单点问题，阶段3中协调者出现问题时，
参与者会继续提交事务

缺点：数据不一致性问题依然存在，协调者与参与者通信出现问题时，协调者想要终止事务会失败，参与者会继续进行事务提交

## 3. 分布式事务解决方案

* TCC
* 全局消息
* 基于可靠消息服务的分布式事务
* 最大努力通知

## 4. 事务补偿TCC

TCC是一种应用层面侵入业务的两阶段提交 代表项目ByteTCC

1. try阶段：主要是对业务系统做检测及资源预留 加锁 锁住资源
2. confirm cancel 

P10